<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-Hive v3.0: Ultimate</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          // REPLACE THIS WITH YOUR ACTUAL PUBLIC KEY
          emailjs.init("YeBpgs1OMwiXLp7LE"); 
       })();
    </script>

    <style>
        /* --- THEME ENGINE --- */
        :root {
            --bg-app: #f4f7f6;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --bg-glass-heavy: rgba(255, 255, 255, 0.95);
            --accent-grad: linear-gradient(135deg, #FFC107 0%, #FF9F1C 100%);
            --accent-solid: #FF9F1C;
            --text-main: #333;
            --text-muted: #666;
            --border: rgba(0,0,0,0.1);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --radius: 12px;
            --font-ui: 'Segoe UI', system-ui, sans-serif;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; transition: all 0.2s ease; }
        
        body { background: var(--bg-app); color: var(--text-main); font-family: var(--font-ui); height: 100vh; overflow: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .glass { background: var(--bg-glass); backdrop-filter: blur(12px); border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: var(--radius); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent-grad); color: white; font-weight: bold; cursor: pointer; width: 100%; }
        .btn:hover { opacity: 0.95; transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); width: auto; padding: 5px 15px; }
        .btn-danger { background: #ff4444; color: white; width: auto; }
        
        .input-box { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border); background: rgba(255,255,255,0.6); font-family: inherit; }
        .input-box:focus { border-color: var(--accent-solid); background: white; }

        /* --- SCREENS --- */
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; background: var(--bg-app); z-index: 10; }
        
        .auth-card { width: 400px; padding: 40px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .brand { font-size: 32px; font-weight: 900; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; }

        /* --- DASHBOARD --- */
        .app-layout { display: flex; width: 100%; height: 100%; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 20; }
        .sidebar.collapsed { width: 80px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; color: var(--text-muted); cursor: pointer; margin-bottom: 5px; }
        .menu-item:hover, .menu-item.active { background: var(--accent-grad); color: white; }
        .menu-icon { font-size: 20px; width: 30px; text-align: center; }
        .menu-label { font-size: 15px; font-weight: 500; white-space: nowrap; }
        .sidebar.collapsed .menu-label { display: none; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { height: 70px; display: flex; align-items: center; padding: 0 30px; border-bottom: 1px solid var(--border); background: var(--bg-glass-heavy); justify-content: space-between; }
        .search-bar { width: 400px; height: 40px; border-radius: 20px; background: rgba(0,0,0,0.05); display: flex; align-items: center; padding: 0 15px; border: 1px solid var(--border); }
        
        .scroll-area { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { border-radius: 12px; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; transition: transform 0.2s; background: white; border: 1px solid var(--border); }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .card-thumb { height: 160px; background: #222; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 40px; position: relative; }
        .card-body { padding: 15px; }
        .card-title { font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between; }

        /* --- CHAT PAGE --- */
        .chat-container { display: flex; height: 100%; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .chat-list { width: 300px; background: white; border-right: 1px solid var(--border); overflow-y: auto; }
        .contact { padding: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .contact:hover, .contact.active { background: #f9f9f9; }
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; }
        .chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 15px; background: white; border-top: 1px solid var(--border); display: flex; gap: 10px; }

        .msg { padding: 8px 14px; border-radius: 12px; max-width: 70%; font-size: 14px; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--accent-grad); color: white; border-radius: 12px 12px 0 12px; }
        .msg.rcvd { align-self: flex-start; background: white; border: 1px solid var(--border); border-radius: 12px 12px 12px 0; }

        /* --- MODALS --- */
        .modal { position: absolute; width: 400px; height: 500px; z-index: 100; display: flex; flex-direction: column; box-shadow: 0 30px 80px rgba(0,0,0,0.4); }
        .modal-head { padding: 12px 15px; background: var(--accent-grad); color: white; cursor: move; display: flex; justify-content: space-between; font-weight: bold; border-radius: var(--radius) var(--radius) 0 0; }
        
        .fab { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent-grad); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 90; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.1); }

        /* --- PLAYER --- */
        .player-frame { width: 100%; height: 100%; border: none; }
        .file-preview { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #eee; color: #555; }

    </style>
</head>
<body>

    <div id="page-splash" class="screen">
        <div class="auth-card glass">
            <div class="brand">B-HIVE</div>
            <p style="margin-bottom: 30px; color: var(--text-muted); line-height: 1.6;">
                The ultimate platform for learning, sharing, and skill development.<br>
                <b>Offline Ready ‚Ä¢ AI Powered ‚Ä¢ Community Driven</b>
            </p>
            <button class="btn" onclick="navTo('page-login')">Sign in / Sign Up</button>
        </div>
    </div>

    <div id="page-login" class="screen hidden">
        <div class="auth-card glass">
            <h2 class="brand">SIGN IN</h2>
            <input type="text" id="login-user" class="input-box" placeholder="Username (try 'demo')">
            <input type="password" id="login-pass" class="input-box" placeholder="Password (try '123')">
            <button class="btn" style="margin-top:10px;" onclick="handleLogin()">Login</button>
            <div style="margin-top:20px; font-size:13px;">
                <span style="color:var(--accent-solid); cursor:pointer; font-weight:bold;" onclick="navTo('page-reg')">Create Account</span>
                <span style="color:var(--text-muted);"> | Forgot Password</span>
            </div>
        </div>
    </div>

    <div id="page-reg" class="screen hidden">
        <div class="auth-card glass">
            <h2 class="brand">SIGN UP</h2>
            
            <div id="reg-step-1">
                <input type="text" id="r-user" class="input-box" placeholder="Choose Username">
                <input type="email" id="r-mail" class="input-box" placeholder="Your Real Email">
                <input type="password" id="r-pass" class="input-box" placeholder="Create Password">
                <div style="text-align:left; font-size:12px; margin: 10px 0;">
                    <input type="checkbox" id="r-terms"> I agree to Terms & Conditions
                </div>
            </div>

            <div id="reg-step-2" class="hidden">
                <p style="color:green; font-weight:bold; margin-bottom:10px;">‚úî OTP Sent to your email!</p>
                <input type="text" id="r-otp" class="input-box" placeholder="Enter 4-Digit Code">
            </div>

            <button class="btn" id="btn-reg-action" style="margin-top:10px;" onclick="initiateRegister()">Get OTP</button>
            <button class="btn-ghost" style="margin-top:10px;" onclick="navTo('page-login')">Back</button>
        </div>
    </div>

    <div id="page-setup" class="screen hidden">
        <div class="auth-card glass">
            <h2>SETUP PROFILE</h2>
            
            <div style="margin: 20px auto; width: 100px; height: 100px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow:hidden; border: 3px solid white; box-shadow: var(--shadow);" onclick="document.getElementById('setup-file').click()">
                <img id="setup-preview" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                <span id="setup-plus" style="font-size:40px; color:white;">+</span>
            </div>
            <input type="file" id="setup-file" class="hidden" accept="image/*" onchange="previewProfile(this)">
            
            <input type="text" id="setup-bio" class="input-box" placeholder="Short Bio (e.g. Student @ MIT)">
            <button class="btn" style="margin-top:10px;" onclick="completeSetup()">Finish Setup</button>
        </div>
    </div>

    <div id="app-wrapper" class="screen hidden" style="align-items: flex-start;">
        <div class="app-layout">
            
            <div class="sidebar" id="sidebar">
                <div class="brand" style="font-size: 24px; margin-bottom: 30px;">B-HIVE</div>
                <div class="menu-item active" onclick="loadView('home')">
                    <div class="menu-icon">üè†</div><div class="menu-label">Home</div>
                </div>
                <div class="menu-item" onclick="loadView('following')">
                    <div class="menu-icon">üë•</div><div class="menu-label">Following</div>
                </div>
                <div class="menu-item" onclick="loadView('chats')">
                    <div class="menu-icon">üí¨</div><div class="menu-label">Chat</div>
                </div>
                <div class="menu-item" onclick="loadView('history')">
                    <div class="menu-icon">üïí</div><div class="menu-label">Past Seen</div>
                </div>
                <div class="menu-item" onclick="loadView('profile')">
                    <div class="menu-icon">üë§</div><div class="menu-label">My Profile</div>
                </div>
                <div class="menu-item" onclick="toggleModal('modal-ai')">
                    <div class="menu-icon">ü§ñ</div><div class="menu-label">AI Helper</div>
                </div>
                <div style="flex:1"></div>
                <div class="menu-item" onclick="logout()">
                    <div class="menu-icon">üö™</div><div class="menu-label">Logout</div>
                </div>
            </div>

            <div class="main-content">
                <div class="top-bar">
                    <button class="btn-ghost" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">‚ò∞</button>
                    <div class="search-bar">
                        <span>üîç</span><input type="text" placeholder="Search..." style="border:none; background:transparent; margin-left:10px; flex:1; outline:none;">
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <button class="btn" style="width:auto;" onclick="openUploadModal()">+ Upload</button>
                        <div id="header-avatar" style="width:40px; height:40px; border-radius:50%; background:var(--accent-solid); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; overflow:hidden;">U</div>
                    </div>
                </div>

                <div id="view-container" class="scroll-area">
                    </div>
                
                <div class="fab" onclick="toggleModal('modal-scratch')" title="Alt + N">‚úé</div>
            </div>
        </div>
    </div>

    <div id="modal-upload" class="screen hidden" style="background: rgba(0,0,0,0.6); z-index: 200;">
        <div class="auth-card glass" style="text-align: left;">
            <h2>UPLOAD CONTENT</h2>
            <input type="text" id="up-title" class="input-box" placeholder="Title">
            <input type="text" id="up-desc" class="input-box" placeholder="Description">
            <select id="up-type" class="input-box" onchange="toggleUpType()">
                <option value="video">YouTube Video</option>
                <option value="local">Local Video (MP4)</option>
                <option value="pdf">PDF / Document</option>
            </select>
            
            <div id="up-input-link">
                <input type="text" id="up-link" class="input-box" placeholder="YouTube Video ID (e.g. dQw4w9WgXcQ)">
            </div>
            <div id="up-input-file" class="hidden">
                <input type="file" id="up-file" class="input-box">
            </div>

            <div style="font-size: 12px; margin: 15px 0;">
                <input type="checkbox" id="up-terms"> I certify this content is mine.
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-ghost" onclick="closeUploadModal()">Cancel</button>
                <button class="btn" onclick="processUpload()">Upload</button>
            </div>
        </div>
    </div>

    <div id="modal-ai" class="modal glass hidden" style="top: 80px; right: 50px;">
        <div class="modal-head" onmousedown="dragStart(event, 'modal-ai')">
            <span>ü§ñ AI Helper</span><span style="cursor:pointer" onclick="toggleModal('modal-ai')">‚úï</span>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; padding:10px;">
            <div id="ai-chat-box" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px;">
                <div class="msg rcvd">Hello! I'm B-Hive AI. Ask me anything!</div>
            </div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="ai-input" class="input-box" style="margin:0;" placeholder="Alt + A to focus...">
                <button class="btn" style="width:auto;" onclick="askAI()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="modal-scratch" class="modal glass hidden" style="top: 100px; left: 100px;">
        <div class="modal-head" onmousedown="dragStart(event, 'modal-scratch')">
            <span>üìù Scratchpad</span><span style="cursor:pointer" onclick="toggleModal('modal-scratch')">‚úï</span>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
            <textarea id="scratch-area" style="flex:1; padding:15px; border:none; background:transparent; resize:none; font-family:monospace;" placeholder="Type your quick notes here..."></textarea>
            <button class="btn" style="border-radius:0 0 12px 12px;" onclick="downloadNote()">Download Note (.txt)</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SERVICE_ID = "service_vihw7oc"; 
        const TEMPLATE_ID = "template_ti87l42";
        const API_KEY = "AIzaSyAzr97nSI1wt3eG_CEYt9LosJjm6eWMYtY"; // Using your key
        
        // --- STATE MANAGEMENT ---
        // Load from LocalStorage or use Defaults
        let DB = {
            users: JSON.parse(localStorage.getItem('bhive_users')) || [],
            posts: JSON.parse(localStorage.getItem('bhive_posts')) || [
                { id: 1, title: "HTML Crash Course", type: "video", src: "pQN-pnXPaVg", author: "CodeMaster", desc: "Learn HTML in 1 hour." },
                { id: 2, title: "Project Docs", type: "pdf", src: "manual.pdf", author: "DevTeam", desc: "Documentation for v1.0" }
            ],
            chats: JSON.parse(localStorage.getItem('bhive_chats')) || [
                { contact: "CodeMaster", msgs: [{from:"them", text:"Welcome to B-Hive!"}] },
                { contact: "StudyGroup", msgs: [{from:"me", text:"Hey everyone"}] }
            ],
            history: JSON.parse(localStorage.getItem('bhive_history')) || []
        };
        
        let currentUser = JSON.parse(localStorage.getItem('bhive_current')) || null;
        let generatedOTP = null;
        let activeChatIdx = -1;

        // --- INIT ---
        window.onload = function() {
            if(currentUser) {
                initApp();
            } else {
                navTo('page-splash');
            }
            
            // KEYBOARD SHORTCUTS
            document.addEventListener('keydown', (e) => {
                if(e.altKey && e.key === 'n') toggleModal('modal-scratch');
                if(e.altKey && e.key === 'a') {
                    toggleModal('modal-ai');
                    setTimeout(() => document.getElementById('ai-input').focus(), 100);
                }
                // Enter Key for Login
                if(e.key === 'Enter' && !document.getElementById('page-login').classList.contains('hidden')) handleLogin();
            });
        };

        // --- NAVIGATION ---
        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- AUTHENTICATION ---
        function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            
            // Demo backdoor
            if(u === 'demo' && p === '123') {
                loginSuccess({ username: 'DemoUser', avatar: 'D', email: 'demo@test.com' });
                return;
            }

            const user = DB.users.find(x => x.username === u && x.password === p);
            if(user) loginSuccess(user);
            else alert("Invalid Credentials");
        }

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('bhive_current', JSON.stringify(user));
            initApp();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('bhive_current');
            location.reload();
        }

        function initApp() {
            navTo('app-wrapper');
            // Update Avatar
            const avDiv = document.getElementById('header-avatar');
            if(currentUser.avatarUrl) {
                avDiv.innerHTML = `<img src="${currentUser.avatarUrl}" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
                avDiv.innerText = currentUser.username[0].toUpperCase();
            }
            loadView('home');
        }

        // --- REGISTRATION LOGIC ---
        function initiateRegister() {
            const u = document.getElementById('r-user').value;
            const e = document.getElementById('r-mail').value;
            
            // Check Duplicates
            if(DB.users.find(x => x.username === u || x.email === e)) {
                return alert("Account with this Username or Email already exists!");
            }
            
            if(!document.getElementById('r-terms').checked) return alert("Accept Terms");
            if(!u || !e) return alert("Fill all fields");

            const btn = document.getElementById('btn-reg-action');
            btn.innerText = "Sending OTP..."; btn.disabled = true;

            generatedOTP = Math.floor(1000 + Math.random() * 9000);

            // SEND EMAIL (Matches your Template Variable 'passcode')
            emailjs.send(SERVICE_ID, TEMPLATE_ID, {
                to_name: u,
                to_email: e,
                passcode: generatedOTP 
            }).then(() => {
                alert("OTP Sent!");
                document.getElementById('reg-step-1').classList.add('hidden');
                document.getElementById('reg-step-2').classList.remove('hidden');
                btn.innerText = "Verify & Finish"; btn.disabled = false;
                btn.onclick = finalizeRegister;
            }).catch(err => {
                alert("Email Failed. Check Console.");
                console.error(err);
                btn.innerText = "Try Again"; btn.disabled = false;
            });
        }

        function finalizeRegister() {
            if(document.getElementById('r-otp').value != generatedOTP) return alert("Wrong OTP");
            
            // Create Temp User
            const u = document.getElementById('r-user').value;
            const p = document.getElementById('r-pass').value;
            const e = document.getElementById('r-mail').value;
            
            currentUser = { username: u, password: p, email: e, avatar: u[0], avatarUrl: null };
            navTo('page-setup');
        }

        // --- PROFILE SETUP ---
        function previewProfile(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('setup-preview').src = e.target.result;
                    document.getElementById('setup-preview').style.display = 'block';
                    document.getElementById('setup-plus').style.display = 'none';
                    currentUser.avatarUrl = e.target.result; // Store base64
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function completeSetup() {
            currentUser.bio = document.getElementById('setup-bio').value;
            DB.users.push(currentUser);
            localStorage.setItem('bhive_users', JSON.stringify(DB.users));
            loginSuccess(currentUser);
        }

        // --- CORE VIEWS ---
        const container = document.getElementById('view-container');

        function loadView(view) {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            // Highlight menu item logic can be added here
            
            container.innerHTML = "";
            
            if(view === 'home') {
                renderGrid(DB.posts, "Explore");
            } else if(view === 'following') {
                renderGrid(DB.posts.slice(0,1), "Following");
            } else if(view === 'history') {
                renderGrid(DB.history, "Recently Viewed");
            } else if(view === 'chats') {
                renderChatInterface();
            } else if(view === 'profile') {
                renderProfile(currentUser, true);
            }
        }

        function renderGrid(posts, title) {
            let html = `<h3>${title}</h3><div class="grid">`;
            if(posts.length === 0) html += `<p>No content yet.</p>`;
            
            posts.forEach(p => {
                let icon = p.type === 'video' ? '‚ñ∂' : (p.type === 'pdf' ? 'üìÑ' : 'üìÅ');
                html += `
                <div class="card" onclick="openContent(${p.id})">
                    <div class="card-thumb">${icon}</div>
                    <div class="card-body">
                        <div class="card-title">${p.title}</div>
                        <div class="card-meta"><span>${p.author}</span><span>${p.type.toUpperCase()}</span></div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- HYBRID PLAYER (Video/Local/File) ---
        function openContent(id) {
            const p = DB.posts.find(x => x.id == id);
            if(!p) return;

            // Add to History
            DB.history = DB.history.filter(x => x.id !== id); // Remove duplicate
            DB.history.unshift(p);
            localStorage.setItem('bhive_history', JSON.stringify(DB.history));

            let playerHTML = "";

            if(p.type === 'video') {
                // Check if YouTube
                if(p.src.length === 11) { // Simple check for YT ID
                    playerHTML = `<iframe class="player-frame" src="https://www.youtube.com/embed/${p.src}" allowfullscreen></iframe>`;
                } else {
                    playerHTML = `<div class="file-preview">Video unavailable (Simulated ID)</div>`;
                }
            } else if (p.type === 'local') {
                 // Create blob URL if it was uploaded in this session, otherwise show placeholder
                 playerHTML = `<video controls class="player-frame" style="background:black;"><source src="${p.src}" type="video/mp4"></video>`;
            } else {
                playerHTML = `<div class="file-preview"><h1>üìÑ ${p.title}</h1><button class="btn" style="width:200px" onclick="downloadFile('${p.title}')">Download File</button></div>`;
            }

            container.innerHTML = `
                <button class="btn-ghost" onclick="loadView('home')">‚Üê Back</button>
                <div style="height:400px; margin-top:10px; border-radius:12px; overflow:hidden;">${playerHTML}</div>
                <div class="glass" style="padding:20px; margin-top:20px;">
                    <h2>${p.title}</h2>
                    <p style="color:#666; margin-top:5px;">${p.desc}</p>
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <strong>By ${p.author}</strong>
                        <button class="btn" style="width:auto;" onclick="alert('Followed!')">Follow</button>
                    </div>
                </div>
            `;
        }

        // --- CHAT SYSTEM ---
        function renderChatInterface() {
            container.innerHTML = `
                <div class="chat-container">
                    <div class="chat-list" id="chat-list-dom"></div>
                    <div class="chat-window">
                        <div class="chat-history" id="chat-msgs-dom">
                            <div style="margin:auto; color:#888;">Select a contact to chat</div>
                        </div>
                        <div class="chat-input-area hidden" id="chat-inputs">
                            <button class="btn-ghost" onclick="document.getElementById('chat-file').click()">+</button>
                            <input type="file" id="chat-file" class="hidden" onchange="sendChatFile()">
                            <input type="text" id="chat-text" class="input-box" style="margin:0;" placeholder="Message...">
                            <button class="btn" style="width:auto;" onclick="sendChat()">Send</button>
                        </div>
                    </div>
                </div>
            `;
            renderContactList();
        }

        function renderContactList() {
            const list = document.getElementById('chat-list-dom');
            list.innerHTML = "";
            DB.chats.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = `contact ${idx === activeChatIdx ? 'active' : ''}`;
                div.innerHTML = `<div style="width:30px;height:30px;background:#ddd;border-radius:50%"></div><b>${c.contact}</b>`;
                div.onclick = () => loadChat(idx);
                list.appendChild(div);
            });
        }

        function loadChat(idx) {
            activeChatIdx = idx;
            document.getElementById('chat-inputs').classList.remove('hidden');
            renderContactList(); // Refresh active state
            renderMessages();
        }

        function renderMessages() {
            const dom = document.getElementById('chat-msgs-dom');
            dom.innerHTML = "";
            const chat = DB.chats[activeChatIdx];
            
            chat.msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.from === 'me' ? 'sent' : 'rcvd'}`;
                div.innerText = m.text;
                dom.appendChild(div);
            });
            dom.scrollTop = dom.scrollHeight;
        }

        function sendChat() {
            const txt = document.getElementById('chat-text').value;
            if(!txt) return;
            
            DB.chats[activeChatIdx].msgs.push({ from: 'me', text: txt });
            localStorage.setItem('bhive_chats', JSON.stringify(DB.chats)); // Persist
            
            document.getElementById('chat-text').value = "";
            renderMessages();
        }

        function sendChatFile() {
             DB.chats[activeChatIdx].msgs.push({ from: 'me', text: "üìé [File Sent]" });
             renderMessages();
        }

        // --- PROFILE ---
        function renderProfile(user, isMe) {
            container.innerHTML = `
                <div class="glass" style="padding:30px; display:flex; align-items:center; gap:20px;">
                    <div style="width:100px; height:100px; border-radius:50%; background:#eee; overflow:hidden;">
                        ${user.avatarUrl ? `<img src="${user.avatarUrl}" style="width:100%;height:100%;object-fit:cover;">` : `<div style="font-size:40px;text-align:center;line-height:100px;">${user.username[0]}</div>`}
                    </div>
                    <div>
                        <h1>${user.username}</h1>
                        <p>${user.bio || "No bio yet."}</p>
                        ${!isMe ? `<button class="btn" style="margin-top:10px; width:auto;">Follow</button>` : `<button class="btn-ghost" style="margin-top:10px;">Edit Profile</button>`}
                    </div>
                </div>
                <h3 style="margin-top:20px;">Uploads</h3>
                <div class="grid" style="margin-top:10px;">
                    ${DB.posts.filter(p => p.author === user.username).map(p => `
                        <div class="card" onclick="openContent(${p.id})">
                             <div class="card-thumb">${p.type=='video'?'‚ñ∂':'üìÑ'}</div>
                             <div class="card-body"><b>${p.title}</b></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- UPLOAD SYSTEM ---
        function openUploadModal() { toggleModal('modal-upload'); }
        function closeUploadModal() { toggleModal('modal-upload'); }
        function toggleUpType() {
            const t = document.getElementById('up-type').value;
            document.getElementById('up-input-link').classList.toggle('hidden', t !== 'video');
            document.getElementById('up-input-file').classList.toggle('hidden', t === 'video');
        }

        function processUpload() {
            if(!document.getElementById('up-terms').checked) return alert("Agree to terms");
            const title = document.getElementById('up-title').value;
            const type = document.getElementById('up-type').value;
            let src = "";

            if(type === 'video') {
                src = document.getElementById('up-link').value;
            } else if (type === 'local' || type === 'pdf') {
                // Create a fake Blob URL for current session access
                const file = document.getElementById('up-file').files[0];
                if(file) {
                    src = URL.createObjectURL(file);
                } else {
                    return alert("Select a file");
                }
            }

            const newPost = {
                id: Date.now(),
                title: title,
                type: type,
                src: src,
                author: currentUser.username,
                desc: document.getElementById('up-desc').value
            };

            DB.posts.unshift(newPost);
            localStorage.setItem('bhive_posts', JSON.stringify(DB.posts));
            closeUploadModal();
            loadView('home');
        }

        // --- UTILS ---
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        
        let activeModal=null,ox=0,oy=0;
        function dragStart(e,id){ activeModal=document.getElementById(id); ox=e.clientX-activeModal.offsetLeft; oy=e.clientY-activeModal.offsetTop; document.onmousemove=dragMove; document.onmouseup=()=>activeModal=null; }
        function dragMove(e){ if(activeModal){ activeModal.style.left=(e.clientX-ox)+'px'; activeModal.style.top=(e.clientY-oy)+'px'; } }

        function downloadFile(name) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["Demo Content"],{type:'text/plain'}));
            a.download = name+".txt"; a.click();
        }
        function downloadNote() {
            const txt = document.getElementById('scratch-area').value;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
            a.download = "note.txt"; a.click();
        }

        // --- AI LOGIC (Fixed Model) ---
        async function askAI() {
            const inp = document.getElementById('ai-input');
            const chat = document.getElementById('ai-chat-box');
            const q = inp.value; if(!q) return;

            chat.innerHTML += `<div class="msg sent" style="align-self:flex-end; color:white;">${q}</div>`;
            inp.value = "Thinking..."; inp.disabled = true;

            try {
                // Corrected Model Name: 1.5-flash
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{parts:[{text:q}]}]})
                });
                const data = await res.json();
                const ans = data.candidates[0].content.parts[0].text;
                chat.innerHTML += `<div class="msg rcvd">${ans}</div>`;
            } catch(e) {
                chat.innerHTML += `<div class="msg rcvd">AI Offline or Error.</div>`;
            }
            inp.value = ""; inp.disabled = false; inp.focus();
            chat.scrollTop = chat.scrollHeight;
        }

    </script>
</body>
</html>